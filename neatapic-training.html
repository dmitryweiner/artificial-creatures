<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'/>
  <link rel="stylesheet" type="text/css" href="css/graph.css">
  <script src="js/lib/neataptic.min.js"></script>
  <script src="js/lib/d3.v3.min.js"></script>
  <script src="js/lib/cola.v3.min.js"></script>
  <script src="js/lib/graph.js"></script>
  <script type="application/javascript">
    const neat = new neataptic.Neat(
            2, // inputs
            1, // outputs
            null, // ranking function
            {
              popsize: 50,
              elitism: 5,
              mutationRate: 0.5,
              mutationAmount: 3
            }
    );
    const ERROR_RATE = 0.0001;

    neataptic.Config.warnings = false;

    for (let i = 0; i < neat.popsize; i++) {
      neat.population[i].score = 0;
    }

    setInterval(() => {
      //rank individuals according to fitness
      for (let i = 0; i < neat.popsize; i++) {
        let result;

        // train XOR function
        result = neat.population[i].activate([0, 0]);
        neat.population[i].score += Math.abs(result[0]) < ERROR_RATE ? 1 : -1;

        result = neat.population[i].activate([0, 1]);
        neat.population[i].score += Math.abs(result[0] - 1) < ERROR_RATE ? 1 : -1;

        result = neat.population[i].activate([1, 0]);
        neat.population[i].score += Math.abs(result[0] - 1) < ERROR_RATE ? 1 : -1;

        result = neat.population[i].activate([1, 1]);
        neat.population[i].score += Math.abs(result[0]) < ERROR_RATE ? 1 : -1;

        //console.log([input1, input2, result, neat.population[i].score]);
      }

      // new generation
      neat.sort();
      document.getElementById('log').innerHTML = JSON.stringify({
        generation: neat.generation,
        max: neat.getFittest().score,
        avg: Math.round(neat.getAverage()),
        min: neat.population[neat.popsize - 1].score
      });

      drawGraph(neat.getFittest().graph(800, 800), '.draw');
      const newGeneration = [];
      for (let i = 0; i < neat.elitism; i++) {
        newGeneration.push(neat.population[i]);
      }
      for (let i = 0; i < neat.popsize - neat.elitism; i++) {
        const offspring = neat.getOffspring();
        offspring.score = 0;
        newGeneration.push(offspring);
      }
      neat.population = newGeneration;
      neat.mutate();
      neat.generation++;
    }, 100);
  </script>
</head>
<body>
<div id="log"></div>
<div class="container">
  <div class="row">
    <svg class="draw" width="800px" height="800px"/>
  </div>
</div>
</body>
</html>